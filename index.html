<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Pincode ‚Äì Quant Prep (Solo)</title>
  <style>
    :root{--bg:#0f1220;--panel:#151936;--accent:#7bd88f;--accent2:#8bd3ff;--text:#eef1ff;--muted:#a8b0d3;--danger:#ff6b6b;--warn:#ffd166}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);
         background:radial-gradient(1000px 600px at 10% -10%, #1a1f45 0%, #0f1220 60%)}
    header{position:sticky;top:0;z-index:5;backdrop-filter:blur(8px);background:rgb(15 18 32 / 72%);
           border-bottom:1px solid #232955;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    header h1{margin:0;font-size:18px;letter-spacing:.3px}
    nav{display:flex;gap:8px;flex-wrap:wrap}
    nav button{background:var(--panel);color:var(--text);border:1px solid #232955;padding:8px 12px;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgb(123 216 143 / .25) inset}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .card{background:linear-gradient(180deg,#161a3a 0%,#10142c 100%);border:1px solid #232955;border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 8px 24px rgb(0 0 0 / .25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}.grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#0c1030;color:var(--text);border:1px solid #232955;padding:12px;border-radius:12px;outline:none;font-size:22px;text-align:center}
    .btn{background:var(--accent);color:#0a1320;border:0;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid #2a316a}
    .btn.danger{background:var(--danger);color:white}
    .btn.huge{font-size:22px;padding:16px 20px;border-radius:16px;min-width:140px}
    .muted{color:var(--muted)} .center{text-align:center}
    .pill{padding:6px 10px;border:1px solid #2a316a;border-radius:999px;color:var(--muted)}
    .timer{font-variant-numeric:tabular-nums}
    .stim{font-size:54px;letter-spacing:3px;margin:10px 0 12px;transition:opacity .2s}
    .cue{font-size:18px;color:var(--accent2);text-transform:uppercase;letter-spacing:1px}
    .flash-ok{color:var(--accent)} .flash-bad{color:var(--danger)}
    table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
    th,td{padding:8px 10px;border-bottom:1px solid #232955}
    tr:hover td{background:#101536}
    .ok{color:var(--accent)}.bad{color:var(--danger)}.warn{color:var(--warn)}
    .linklike{color:var(--accent2);cursor:pointer;text-decoration:underline}
    .kbd{background:#0c1030;border:1px solid #232955;border-radius:6px;padding:2px 6px;font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>üî¢ Pincode ‚Äì Solo</h1>
  <nav id="tabs"></nav>
  <div style="margin-left:auto"></div>
  <button class="btn ghost" id="exportJson">Export JSON</button>
  <button class="btn ghost" id="exportCsv">Export CSV</button>
  <button class="btn ghost" id="resetAll">Reset</button>
</header>
<main id="app"></main>

<script>
/************* Utils *************/
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const now=()=>performance.now();
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const fmtMs=ms=>(ms/1000).toFixed(2)+"s";
function dl(name,data,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
const rndInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=a=>a[Math.floor(Math.random()*a.length)];
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]];} return a;}
const digitsToStr = arr => arr.join('');
const bullets = n => Array(n).fill('‚Ä¢').join(' ');

/************* Storage *************/
const DBKEY='pc_db_v3';
function load(key,def){try{return JSON.parse(localStorage.getItem(key))||structuredClone(def);}catch{ return structuredClone(def);}}
function save(key,val){localStorage.setItem(key,JSON.stringify(val));}
let DB=load(DBKEY,{sessions:[],highscores:{}});

function pushSession(entry){
  DB.sessions.push({...entry, date:new Date().toISOString()});
  const sc=entry.stats?.score ?? entry.stats?.correct ?? 0;
  if(!DB.highscores.pc || sc>DB.highscores.pc.score){
    DB.highscores.pc={score:sc, when:new Date().toISOString(), detail:entry.stats};
  }
  save(DBKEY,DB);
}

/************* Low-level Generators *************/
function randDigits(len, allowZero=true, allowRepeats=true){
  const pool=allowZero?[0,1,2,3,4,5,6,7,8,9]:[1,2,3,4,5,6,7,8,9];
  if(allowRepeats){
    const out=[]; for(let i=0;i<len;i++) out.push(pick(pool)); return out;
  }else{
    const p=pool.slice(); shuffle(p); return p.slice(0,len);
  }
}
function applyRule(d, rule){
  switch(rule){
    case 'PLUS1': return (d+1)%10;
    case 'MINUS1': return (d+9)%10;
    case 'PLUS2': return (d+2)%10;
    case 'NINE_MINUS_D': return 9-d;
    case 'TIMES2_MOD10': return (d*2)%10;
    default: return d;
  }
}
const RULE_LABEL={
  PLUS1:'+1 (mod 10)', MINUS1:'‚àí1 (mod 10)', PLUS2:'+2 (mod 10)', NINE_MINUS_D:'9‚àíd', TIMES2_MOD10:'√ó2 (mod 10)'
};

/************* App-Shell *************/
const tabs=[
  {id:'classic', label:'Classic', view:viewClassic},
  {id:'step',    label:'Step (Gef√ºhrt)', view:viewStep},
  {id:'trainer', label:'Trainer (Step-Up)', view:viewTrainer},
  {id:'pro',     label:'Pro (Mixed)', view:viewPro},
  {id:'stats',   label:'Statistik', view:viewStats},
  {id:'settings',label:'Einstellungen', view:viewSettings},
];
let currentTab=localStorage.getItem('pc_tab3')||'classic';
function renderTabs(){ const nav=$('#tabs'); nav.innerHTML=''; tabs.forEach(t=>{ const b=document.createElement('button'); b.textContent=t.label; b.className=currentTab===t.id?'active':''; b.onclick=()=>{currentTab=t.id; localStorage.setItem('pc_tab3',currentTab); render();}; nav.appendChild(b);});}
function render(){ renderTabs(); const root=$('#app'); root.innerHTML=''; (tabs.find(t=>t.id===currentTab)||tabs[0]).view(root); }

/************* Export / Reset *************/
$('#exportJson').onclick=()=>dl('pincode_stats_'+new Date().toISOString().slice(0,10)+'.json',JSON.stringify(DB,null,2),'application/json');
$('#exportCsv').onclick=()=>{
  const rows=[["module","date","score","correct","wrong","skipped","detail_json","settings_json"]];
  for(const s of DB.sessions.filter(s=>s.module.startsWith('pc'))){
    rows.push([s.module,s.date,s.stats?.score??'',s.stats?.correct??'',s.stats?.wrong??'',s.stats?.skipped??'',JSON.stringify(s.perQuestion||[]),JSON.stringify(s.settings||{})]);
  }
  dl('pincode_stats_'+new Date().toISOString().slice(0,10)+'.csv',
     rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n'),
     'text/csv');
};
$('#resetAll').onclick=()=>{ if(confirm('Alle lokalen Daten l√∂schen?')){ localStorage.removeItem(DBKEY); DB=load(DBKEY,{sessions:[],highscores:{}}); render(); } };

/************* CLASSIC *************/
function viewClassic(root){
  root.appendChild(card(`<h2>üî¢ Classic PIN</h2>
    <div class="muted">Tippe die angezeigte PIN exakt ab. <b>Auto-Advance</b> bei Treffer. <b>Skip</b> legt sie ans Ende. Die Ziffern blenden nach kurzer Zeit aus.</div>`));

  const cfg={rounds:3, sec:60, len:4};
  const panel=card(); panel.appendChild(formRow([
    numberField('Runden',1,10,1,cfg.rounds,v=>cfg.rounds=v),
    numberField('Sekunden pro Runde',10,300,5,cfg.sec,v=>cfg.sec=v),
    selectField('PIN-L√§nge', [['3','3'],['4','4'],['5','5'],['6','6']], v=>cfg.len=parseInt(v), String(cfg.len)),
    btn('Start',()=>run())
  ]));
  root.appendChild(panel);

  const best=DB.highscores.pc; const hi=card('<h3>üèÜ Highscore</h3>');
  hi.insertAdjacentHTML('beforeend', best?`<div class="pill">Richtig: <b>${best.score}</b> ¬∑ ${new Date(best.when).toLocaleString()}</div>`:'<div class="muted">Noch kein Highscore.</div>');
  root.appendChild(hi);

  function run(){
    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Runde: <b id="rc">1</b> / ${cfg.rounds}</span>
        <span class="pill">Zeit: <span id="t" class="timer">‚Äî</span></span>
        <span class="pill">Score: <b id="sc">0</b></span>
      </div>
      <div class="center" style="margin-top:6px">
        <div class="cue">Code</div>
        <div id="stim" class="stim">1234</div>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <input id="a" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Tippe hier‚Ä¶" maxlength="${cfg.len}" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="width:260px">
        <button id="ok" class="btn huge">OK</button>
        <button id="skip" class="btn ghost huge">Skip</button>
        <button id="clear" class="btn ghost huge">Clear</button>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <button id="pause" class="btn ghost">Pause</button>
        <button id="abort" class="btn danger">Abbrechen</button>
      </div>
      <div class="muted center" style="margin-top:6px">
        Shortcuts: <span class="kbd">Enter</span>=OK ¬∑ <span class="kbd">Space</span>=Skip ¬∑ <span class="kbd">Esc</span>=Clear ¬∑ <span class="kbd">P</span>=Pause
      </div>
    `;

    const el={rc:$('#rc',ui),t:$('#t',ui),sc:$('#sc',ui),stim:$('#stim',ui),
              a:$('#a',ui),ok:$('#ok',ui),skip:$('#skip',ui),clear:$('#clear',ui),pause:$('#pause',ui),abort:$('#abort',ui)};

    // state
    let round=0, score=0, correct=0, wrong=0, skipped=0;
    let cur='', queue=[]; const per=[];
    let tStart=0, paused=false, pauseT=0, tPause=0, running=true;
    let qStart=0, qPaused=0, qPauseStart=0;
    let hideTimer=null;
    let trialActive=false;
    let finished=false;

    function focusInput(){ el.a.focus(); const pos=el.a.value.length; el.a.setSelectionRange(pos,pos); }
    const maskStim = ()=>{ el.stim.textContent = bullets(cfg.len); };
    const scheduleMask = ()=>{ clearTimeout(hideTimer); const delay = 1200 + cfg.len*80; hideTimer=setTimeout(maskStim,delay); };

    function tick(){
      if(!running) return;
      let tNow=performance.now(); if(paused) tNow=tPause;
      const used=tNow-tStart-pauseT, left=Math.max(0, cfg.sec*1000-used);
      el.t.textContent=(left/1000).toFixed(1)+'s';
      if(left<=0){ endRound(true); return; }
      requestAnimationFrame(tick);
    }
    function newCode(){
      clearTimeout(hideTimer);
      cur = queue.length ? queue.shift() : digitsToStr(randDigits(cfg.len,true,true));
      el.stim.style.opacity=1; el.stim.textContent=cur.split('').join(' ');
      el.a.value=''; qStart=now(); qPaused=0; trialActive=true; focusInput(); scheduleMask();
    }
    function submit(kind){
      if(!running) return;
      if(kind==='clear'){ el.a.value=''; focusInput(); return; }
      if(kind==='skip'){ skipped++; queue.push(cur); per.push({round:round+1, kind:'classic', code:cur, user:'', correct:null, ms:'', skipped:1}); trialActive=false; newCode(); return; }
      const user=el.a.value; if(user.length!==cfg.len){ focusInput(); return; }
      const ms=Math.round(now()-qStart - qPaused); const ok=(user===cur);
      if(ok){ score++; correct++; } else { wrong++; }
      per.push({round:round+1, kind:'classic', code:cur, user, correct:ok?1:0, ms});
      trialActive=false; newCode(); el.sc.textContent=String(score);
    }
    function pause(){ if(!running) return;
      if(!paused){ paused=true; tPause=performance.now(); qPauseStart=now(); el.pause.textContent='Resume'; } 
      else { paused=false; pauseT+=performance.now()-tPause; qPaused+=now()-qPauseStart; el.pause.textContent='Pause'; requestAnimationFrame(tick);} 
      focusInput();
    }
    function endRound(byTimeout=false){
      if(byTimeout && trialActive){
        per.push({round:round+1, kind:'classic', code:cur, user:'', correct:0, ms:'', deadline:1});
        wrong++; trialActive=false;
      }
      round++;
      if(round<cfg.rounds){ el.rc.textContent=String(round+1); startRound(); }
      else { finish(); }
    }
    function startRound(){ tStart=performance.now(); pauseT=0; paused=false; el.pause.textContent='Pause'; qStart=now(); qPaused=0; newCode(); requestAnimationFrame(tick); }
    function finish(){
      if(finished) return; finished=true;
      running=false; clearTimeout(hideTimer);
      const stats={correct, wrong, skipped, score};
      pushSession({module:'pc_classic', stats, settings:{...cfg}, perQuestion:per});
      const rows=[["#","Round","Code","Your","OK","ms"]]; per.forEach((x,i)=>rows.push([i+1,x.round,x.code,x.user??'', x.correct===1?'1':(x.correct===0?'0':''), x.ms??'']));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,i)=>`${i+1}. [r${x.round}] ${x.code} | your=${x.user||'SKIP'} | ${x.correct===1?'OK':(x.correct===0?'X':'SKIP')} | ${x.ms||''}ms`).join('\n');
      ui.innerHTML=`<h3>Ergebnis</h3>
        <div class="row"><span class="pill">Richtig: <b class="ok">${correct}</b></span>
        <span class="pill">Falsch: <b class="bad">${wrong}</b></span>
        <span class="pill">Skips: <b class="warn">${skipped}</b></span>
        <span class="pill">Score: <b>${score}</b></span></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="dlCsv">Download CSV</button>
        <button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,idx)=>[idx+1,x.round,x.code,x.user||'‚Äî',x.correct===1?'‚úÖ':(x.correct===0?'‚ùå':'‚è≠'),(x.ms? (x.ms/1000).toFixed(2)+'s':'')]),['#','Runde','Code','Deine','OK','Zeit'])}`;
      $('#dlCsv',ui).onclick=()=>dl('pincode_classic_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('pincode_classic_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    el.ok.onmousedown=e=>e.preventDefault(); el.skip.onmousedown=e=>e.preventDefault(); el.clear.onmousedown=e=>e.preventDefault();
    el.ok.onclick=()=>submit('ok'); el.skip.onclick=()=>submit('skip'); el.clear.onclick=()=>submit('clear'); el.pause.onclick=pause;
    el.abort.onclick=()=>{ if(confirm('Ohne Speichern beenden?')){ running=false; clearTimeout(hideTimer); ui.innerHTML='<div class="card">Abgebrochen ‚Äì nicht gespeichert.</div>'; } };
    el.a.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); submit('ok'); } else if(e.key===' '){ e.preventDefault(); submit('skip'); } else if(e.key==='Escape'){ e.preventDefault(); submit('clear'); } });
    el.a.addEventListener('input',()=>{ const v=el.a.value.replace(/\D/g,'').slice(0,cfg.len); if(el.a.value!==v) el.a.value=v; if(v.length===cfg.len && v===cur) submit('ok'); });

    startRound(); focusInput();
  }
}

/************* STEP (Gef√ºhrt, ohne Zeitdruck) *************/
function viewStep(root){
  root.appendChild(card(`<h2>ü™ú Step (Gef√ºhrt, ohne Zeitdruck)</h2>
    <div class="muted">Stufenfolge: <b>Repeat</b> ‚Üí <b>Reverse</b> ‚Üí <b>Sort ASC</b> ‚Üí <b>Sort DESC</b>.
    Stufenwechsel <b>nur bei korrekter Eingabe</b>. Kein Antwort-Timer. Auto-Advance nur bei exakt richtiger Eingabe.</div>`));

  const cfg={ lenMin:3, lenMax:6, allowZero:true, allowRepeats:true,
              showPerDigit:[900,1500], iti:[200,500] };

  const panel=card(); panel.appendChild(formRow([
    numberField('L√§nge min',3,8,1,cfg.lenMin,v=>cfg.lenMin=v),
    numberField('L√§nge max',4,9,1,cfg.lenMax,v=>cfg.lenMax=v),
    btn('Start',()=>run())
  ]));
  root.appendChild(panel);

  const perDigitMs = ()=>rndInt(cfg.showPerDigit[0], cfg.showPerDigit[1]);
  const itiMs      = ()=>rndInt(cfg.iti[0], cfg.iti[1]);
  const randLen    = ()=>rndInt(cfg.lenMin, cfg.lenMax);

  function run(){
    const stages=[
      {id:'repeat',   label:'Repeat'},
      {id:'reverse',  label:'Reverse'},
      {id:'sort-asc', label:'Sort ASC'},
      {id:'sort-desc',label:'Sort DESC'},
    ];
    let stageIdx=0;

    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Stufe: <b id="stageL">‚Äî</b></span>
        <span class="pill">Score: <b id="sc">0</b></span>
        <span class="pill">Item: <b id="ic">0</b></span>
      </div>
      <div class="center" style="margin-top:6px">
        <div id="cue" class="cue">‚Äî</div>
        <div id="stim" class="stim">‚Ä¢</div>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <input id="a" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Antwort‚Ä¶" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="width:280px">
        <button id="ok" class="btn huge">OK</button>
        <button id="skip" class="btn ghost huge">Skip</button>
        <button id="clear" class="btn ghost huge">Clear</button>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <button id="abort" class="btn danger">Abbrechen</button>
      </div>`;

    const el={ stageL:$('#stageL',ui), sc:$('#sc',ui), ic:$('#ic',ui),
               cue:$('#cue',ui), stim:$('#stim',ui),
               a:$('#a',ui), ok:$('#ok',ui), skip:$('#skip',ui), clear:$('#clear',ui), abort:$('#abort',ui) };

    // Stats & State
    const per=[]; let score=0, correct=0, wrong=0, skipped=0;
    let running=true, finished=false;
    let state='IDLE', cur=null, qStart=0, answered=false;

    // Timer handling
    const timers=[]; const setT=(fn,ms)=>{ const id=setTimeout(fn,ms); timers.push(id); return id; };
    const clearAll=()=>{ while(timers.length) clearTimeout(timers.pop()); };

    const stageLabel=()=>{ el.stageL.textContent=stages[stageIdx]?.label||'‚Äî'; };
    const updateHUD =()=>{ el.sc.textContent=String(score); el.ic.textContent=String(per.length); };

    function makeItem(){
      const L=randLen(); const base=randDigits(L,cfg.allowZero,cfg.allowRepeats); const baseStr=digitsToStr(base);
      const id=stages[stageIdx]?.id;
      if(id==='repeat')    return {kind:'repeat',  cue:'REPEAT',     len:L, baseStr, target:baseStr};
      if(id==='reverse')   return {kind:'reverse', cue:'REVERSE',    len:L, baseStr, target:digitsToStr([...base].reverse())};
      if(id==='sort-asc')  { const out=[...base].sort((a,b)=>a-b); return {kind:'sort', cue:'SORT ASC',  len:L, baseStr, target:digitsToStr(out)}; }
      if(id==='sort-desc') { const out=[...base].sort((a,b)=>a-b).reverse(); return {kind:'sort', cue:'SORT DESC', len:L, baseStr, target:digitsToStr(out)}; }
      return {kind:'repeat', cue:'REPEAT', len:L, baseStr, target:baseStr};
    }

    function nextItem(){
      if(!running) return;
      clearAll();
      answered=false;
      state='SHOW';
      stageLabel();
      cur=makeItem();
      el.cue.textContent=cur.cue;
      el.a.value=''; el.a.maxLength=cur.len; el.a.focus();
      el.stim.textContent=cur.baseStr.split('').join(' ');
      setT(()=>{ el.stim.textContent=bullets(cur.len); state='ANSWER'; qStart=now(); }, perDigitMs());
    }

    function flash(ok){
      el.stim.classList.remove('flash-ok','flash-bad');
      el.stim.classList.add(ok?'flash-ok':'flash-bad');
      setT(()=>el.stim.classList.remove('flash-ok','flash-bad'),150);
    }

    function pushRec(r){
      per.push(r);
      if(r.skipped){ skipped++; }
      else if(r.correct){ correct++; score+=1; }
      else { wrong++; }
      updateHUD();
    }

    function queueNext(){ state='ITI'; setT(nextItem, itiMs()); }

    function submit(kind){
      if(!running || state!=='ANSWER' || answered) return;
      if(kind==='clear'){ el.a.value=''; el.a.focus(); return; }
      if(kind==='skip'){
        answered=true;
        pushRec({kind:cur.kind, cue:cur.cue, code:cur.baseStr, target:cur.target, user:'', correct:null, len:cur.len, ms:''});
        return queueNext(); // bleibt in derselben Stufe
      }
      const user=el.a.value;
      if(user.length!==cur.len){ el.a.focus(); return; }

      answered=true;
      const ms=Math.round(now()-qStart);
      const ok=(user===cur.target);
      flash(ok);
      pushRec({kind:cur.kind, cue:cur.cue, code:cur.baseStr, target:cur.target, user, correct:ok?1:0, len:cur.len, ms});

      if(ok){
        stageIdx++;                 // nur bei korrekt weiter
        if(stageIdx>=stages.length) return finish();
      }
      queueNext();                   // sonst neue Aufgabe, gleiche Stufe
    }

    function finish(){
      if(finished) return; finished=true; running=false;
      clearAll();
      const stats={correct, wrong, skipped, score};
      pushSession({module:'pc_step', stats, settings:{...cfg, mode:'no-time'}, perQuestion:per});
      const rows=[["#","kind","cue","code","target","user","ok","ms"]];
      per.forEach((x,i)=>rows.push([i+1,x.kind,x.cue||'',x.code||'',x.target||'',x.user??'',x.correct==null?'':(x.correct?1:0),x.ms||'']));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,i)=>`${i+1}. ${x.kind} | ${x.cue||''} | base=${x.code||''} | targ=${x.target||''} | user=${x.user??''} | ok=${x.correct==null?'':(x.correct?1:0)} | ms=${x.ms||''}`).join('\n');
      ui.innerHTML=`<h3>Ergebnis (Step, ohne Zeitdruck)</h3>
        <div class="row"><span class="pill">Richtig: <b class="ok">${stats.correct}</b></span>
        <span class="pill">Falsch: <b class="bad">${stats.wrong}</b></span>
        <span class="pill">Skips: <b class="warn">${stats.skipped}</b></span>
        <span class="pill">Score: <b>${stats.score}</b></span></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="dlCsv">Download CSV</button>
        <button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.map((x,i)=>[i+1,x.kind,x.cue||'',x.code||'‚Äî',x.target||'‚Äî',x.user??'‚Äî',x.correct==null?'‚è≠':(x.correct? '‚úÖ':'‚ùå'),x.ms? (x.ms/1000).toFixed(2)+'s':'']),['#','Typ','Cue','Basis','Ziel','Antwort','OK','Zeit'])}`;
      $('#dlCsv',ui).onclick=()=>dl('pincode_step_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('pincode_step_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    // Controls
    el.ok.onclick   = ()=>submit('ok');
    el.skip.onclick = ()=>submit('skip');
    el.clear.onclick= ()=>submit('clear');
    el.a.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ e.preventDefault(); submit('ok'); }
      else if(e.key===' '){ e.preventDefault(); submit('skip'); }
    });
    el.a.addEventListener('input',()=>{
      if(state!=='ANSWER' || !cur || answered) return;
      const v=el.a.value.replace(/\D/g,'').slice(0,cur.len);
      if(el.a.value!==v) el.a.value=v;
      if(v.length===cur.len && v===cur.target) submit('ok');
    });
    el.abort.onclick=()=>{ if(confirm('Ohne Speichern beenden?')){ running=false; finish(); } };

    nextItem();
  }
}

/************* TRAINER (Step-Up) *************/
function viewTrainer(root){
  root.appendChild(card(`<h2>üß± Trainer (Step-Up)</h2>
    <div class="muted">Zwischenstufe: Recall, Reverse, Sort (ASC), Rule (+1 oder 9‚àíd). Anzeige ‚Üí Maskierung ‚Üí Antwort. Skip legt Item ans Ende. <b>Auto-Advance</b> bei korrekter Eingabe.</div>`));

  const cfg={
    seconds:240,
    lenMin:4, lenMax:7, allowZero:true, allowRepeats:true,
    showPerDigit:[800,1400], answerTimeout:[1500,2500], iti:[300,700],
    mix:{recall:.20, reverse:.30, sort:.25, rule:.25}
  };

  const panel=card(); panel.appendChild(formRow([
    numberField('Session (s)',60,1200,10,cfg.seconds,v=>cfg.seconds=v),
    numberField('L√§nge min',3,8,1,cfg.lenMin,v=>cfg.lenMin=v),
    numberField('L√§nge max',4,9,1,cfg.lenMax,v=>cfg.lenMax=v),
    btn('Start',()=>run())
  ]));
  root.appendChild(panel);

  function perDigitMs(){ return rndInt(cfg.showPerDigit[0], cfg.showPerDigit[1]); }
  function ansTimeoutMs(){ return rndInt(cfg.answerTimeout[0], cfg.answerTimeout[1]); }
  function itiMs(){ return rndInt(cfg.iti[0], cfg.iti[1]); }
  function randLen(){ return rndInt(cfg.lenMin, cfg.lenMax); }
  function pickWeighted(m){ const entries=Object.entries(m); const s=entries.reduce((a,[,w])=>a+w,0); let r=Math.random()*s; for(const [k,w] of entries){ if((r-=w)<=0) return k; } return entries[0][0]; }

  function makeItem(){
    const kind=pickWeighted(cfg.mix);
    const L=randLen(); const base=randDigits(L,cfg.allowZero,cfg.allowRepeats); const baseStr=digitsToStr(base);
    if(kind==='recall')  return {kind,cue:'RECALL', len:L, baseStr, target:baseStr};
    if(kind==='reverse') return {kind,cue:'REVERSE', len:L, baseStr, target:digitsToStr([...base].reverse())};
    if(kind==='sort'){ const out=[...base].sort((a,b)=>a-b); return {kind,cue:'SORT ASC', len:L, baseStr, target:digitsToStr(out)}; }
    if(kind==='rule'){ const R=Math.random()<.5?'PLUS1':'NINE_MINUS_D'; const out=base.map(d=>applyRule(d,R)); return {kind,cue:`RULE ${RULE_LABEL[R]}`, len:L, baseStr, target:digitsToStr(out)}; }
    return {kind:'recall', cue:'RECALL', len:L, baseStr, target:baseStr};
  }

  function run(){
    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Zeit: <span id="t" class="timer">‚Äî</span></span>
        <span class="pill">Score: <b id="sc">0</b></span>
        <span class="pill">Item: <b id="ic">0</b></span>
      </div>
      <div class="center" style="margin-top:6px">
        <div id="cue" class="cue">‚Äî</div>
        <div id="stim" class="stim">‚Ä¢</div>
      </div>
      <div id="answerBlock" class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <input id="a" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Antwort‚Ä¶" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="width:280px">
        <button id="ok" class="btn huge">OK</button>
        <button id="skip" class="btn ghost huge">Skip</button>
        <button id="clear" class="btn ghost huge">Clear</button>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <button id="abort" class="btn danger">Abbrechen</button>
      </div>`;

    const el={t:$('#t',ui),sc:$('#sc',ui),ic:$('#ic',ui),cue:$('#cue',ui),stim:$('#stim',ui),
              a:$('#a',ui),ok:$('#ok',ui),skip:$('#skip',ui),clear:$('#clear',ui),abort:$('#abort',ui)};

    const per=[]; let score=0, correct=0, wrong=0, skipped=0;
    let running=true, finished=false; const totalMs=cfg.seconds*1000; const timers=[];
    let state='IDLE', cur=null, qStart=0, currentFail=null;

    const setT=(fn,ms)=>{ const id=setTimeout(fn,ms); timers.push(id); return id; };
    const clearAll=()=>{ while(timers.length) clearTimeout(timers.pop()); };

    function updateHUD(){ el.sc.textContent=String(score); el.ic.textContent=String(per.length); }
    function pushRec(r){ per.push(r); if(r.skipped){skipped++;} else if(r.correct){correct++;score+=1;} else {wrong++;} updateHUD(); }

    function nextItem(){
      if(!running) return;
      cur=makeItem(); el.cue.textContent=cur.cue; el.a.value=''; el.a.maxLength=cur.len; el.a.focus();
      el.stim.textContent=cur.baseStr.split('').join(' ');
      setT(()=>{ el.stim.textContent=bullets(cur.len); startAnswer(); }, perDigitMs());
    }
    function startAnswer(){
      state='ANSWER'; qStart=now();
      const deadline=ansTimeoutMs();
      currentFail=()=>{ pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user:'', correct:0, ms:'', len:cur.len, deadline:1}); startITI(); };
      setT(currentFail, deadline);
    }
    function submit(kind){
      if(!running || state!=='ANSWER') return;
      if(kind==='skip'){ pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user:'', correct:null, ms:'', len:cur.len, skipped:1}); startITI(); return; }
      if(kind==='clear'){ el.a.value=''; el.a.focus(); return; }
      const user=el.a.value; if(user.length!==cur.len){ el.a.focus(); return; }
      const ms=Math.round(now()-qStart); const ok=(user===cur.target);
      pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user, correct:ok?1:0, ms, len:cur.len});
      startITI();
    }
    function startITI(){ currentFail=null; state='ITI'; setT(()=>{ nextItem(); }, itiMs()); }

    function finish(){
      if(finished) return; finished=true;
      running=false; clearAll();
      const stats={correct, wrong, skipped, score};
      pushSession({module:'pc_trainer', stats, settings:{...cfg}, perQuestion:per});
      const rows=[["#","kind","cue","code","target","user","ok","ms"]];
      per.forEach((x,i)=>rows.push([i+1,x.kind,x.cue||'',x.code||'',x.target||'',x.user??'',x.correct==null?'':(x.correct?1:0),x.ms||'']));
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,i)=>`${i+1}. ${x.kind} | ${x.cue||''} | base=${x.code||''} | targ=${x.target||''} | user=${x.user??''} | ok=${x.correct==null?'':(x.correct?1:0)} | ms=${x.ms||''}`).join('\n');
      ui.innerHTML=`<h3>Ergebnis (Trainer)</h3>
        <div class="row"><span class="pill">Richtig: <b class="ok">${stats.correct}</b></span>
        <span class="pill">Falsch: <b class="bad">${stats.wrong}</b></span>
        <span class="pill">Skips: <b class="warn">${stats.skipped}</b></span>
        <span class="pill">Score: <b>${stats.score}</b></span></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="dlCsv">Download CSV</button>
        <button class="btn ghost" id="dlTxt">Download TXT</button></div>
        ${table(per.slice(-200).map((x,i)=>[i+1,x.kind,x.cue||'',x.code||'‚Äî',x.target||'‚Äî',x.user??'‚Äî',x.correct==null?'‚è≠':(x.correct? '‚úÖ':'‚ùå'),x.ms? (x.ms/1000).toFixed(2)+'s':'']),['#','Typ','Cue','Basis','Ziel','Antwort','OK','Zeit'])}`;
      $('#dlCsv',ui).onclick=()=>dl('pincode_trainer_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('pincode_trainer_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    const t0=performance.now();
    (function loop(){
      if(!running) return;
      const used=performance.now()-t0, left=Math.max(0, totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+'s';
      if(left<=0){ if(typeof currentFail==='function') currentFail(); return finish(); }
      requestAnimationFrame(loop);
    })();

    el.ok.onclick=()=>submit('ok'); el.skip.onclick=()=>submit('skip'); el.clear.onclick=()=>submit('clear');
    el.a.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); submit('ok'); } else if(e.key===' '){ e.preventDefault(); submit('skip'); } });
    el.a.addEventListener('input',()=>{
      if(state!=='ANSWER' || !cur) return;
      const v=el.a.value.replace(/\D/g,'').slice(0,cur.len);
      if(el.a.value!==v) el.a.value=v;
      if(v.length===cur.len && v===cur.target) submit('ok');
    });
    el.abort.onclick=()=>{ if(confirm('Ohne Speichern beenden?')){ running=false; finish(); } };

    nextItem();
  }
}

/************* PRO (Mixed, robustes Timeout-Ende) *************/
function viewPro(root){
  root.appendChild(card(`<h2>üß† Pro PIN (Mixed)</h2>
    <div class="muted">Recall/Reverse/Sort/Rule/Rule-Switch/Sternberg/n-back/Interferenz. Skips ‚Üí ans Ende. Offene Trials werden bei Zeitablauf als falsch gewertet. <b>Auto-Advance</b> bei korrekter Eingabe.</div>`));

  const cfg={
    seconds:360,
    lenMin:4, lenMax:8,
    allowZero:true, allowRepeats:true,
    showPerDigit:[600,2000], answerTimeout:[1200,3000], iti:[300,700],
    mix:{recall:.10, reverse:.15, sort:.15, rule:.15, switch:.15, sternberg:.10, nback:.10, interference:.10},
    rulesAtomic:['PLUS1','MINUS1','PLUS2','NINE_MINUS_D','TIMES2_MOD10'],
    switchPairs:[['PLUS1','MINUS1'],['NINE_MINUS_D','PLUS2']],
    nback:{n:2, streamLen:40, targetRate:0.25},
    sternberg:{setLen:[3,6], probes:12, targetRate:0.5}
  };

  const panel=card(); panel.appendChild(formRow([
    numberField('Session (s)',60,1200,10,cfg.seconds,v=>cfg.seconds=v),
    numberField('L√§nge min',3,8,1,cfg.lenMin,v=>cfg.lenMin=v),
    numberField('L√§nge max',4,9,1,cfg.lenMax,v=>cfg.lenMax=v),
    btn('Start',()=>run())
  ]));
  root.appendChild(panel);

  function perDigitMs(){ return rndInt(cfg.showPerDigit[0], cfg.showPerDigit[1]); }
  function ansTimeoutMs(){ return rndInt(cfg.answerTimeout[0], cfg.answerTimeout[1]); }
  function itiMs(){ return rndInt(cfg.iti[0], cfg.iti[1]); }
  function randLen(){ return rndInt(cfg.lenMin, cfg.lenMax); }
  function pickWeighted(m){ const entries=Object.entries(m); const s=entries.reduce((a,[,w])=>a+w,0); let r=Math.random()*s; for(const [k,w] of entries){ if((r-=w)<=0) return k; } return entries[0][0]; }

  function makeItem(kindOverride=null){
    const kind = kindOverride || pickWeighted(cfg.mix);
    const L = randLen();
    const base = randDigits(L, cfg.allowZero, cfg.allowRepeats);
    const baseStr = digitsToStr(base);
    const common = {kind, base, baseStr, len:L};
    if(kind==='recall'){ return {...common, cue:'RECALL', target:baseStr}; }
    if(kind==='reverse'){ return {...common, cue:'REVERSE', target:digitsToStr([...base].reverse())}; }
    if(kind==='sort'){
      const mode = Math.random()<.5?'ASC':'DESC';
      const out = [...base].sort((a,b)=>a-b); if(mode==='DESC') out.reverse();
      return {...common, cue:`SORT ${mode}`, mode, target:digitsToStr(out)};
    }
    if(kind==='rule'){
      const R=pick(cfg.rulesAtomic); const out=base.map(d=>applyRule(d,R));
      return {...common, cue:`RULE ${RULE_LABEL[R]}`, rule:R, target:digitsToStr(out)};
    }
    if(kind==='switch'){
      const [A,B]=pick(cfg.switchPairs); const mode = Math.random()<.5?'byPosition':'byParity';
      const out = base.map((d,i)=> applyRule(d, (mode==='byPosition') ? (i%2===0?A:B) : (d%2===0?A:B)) );
      return {...common, cue:`SWITCH ${RULE_LABEL[A]} / ${RULE_LABEL[B]} (${mode==='byPosition'?'pos':'par'})`, ruleA:A, ruleB:B, switchMode:mode, target:digitsToStr(out)};
    }
    if(kind==='interference'){
      const inner = makeItem(pick(['reverse','sort','rule']));
      const a=rndInt(12,99), b=Math.random()<.5?rndInt(12,99):rndInt(6,18);
      const op = Math.random()<.5?'+':'√ó'; const distract=`${a} ${op} ${b}`;
      return {...inner, kind:'interference', cue:`INTERF ¬∑ dann ${inner.cue}`, distract};
    }
    if(kind==='sternberg'){
      const setLen=rndInt(cfg.sternberg.setLen[0], cfg.sternberg.setLen[1]);
      const set = randDigits(setLen, cfg.allowZero, false);
      const probes = []; const isT=[];
      const targetCnt = Math.round(cfg.sternberg.probes*cfg.sternberg.targetRate);
      let tLeft=targetCnt, nLeft=cfg.sternberg.probes;
      for(let i=0;i<cfg.sternberg.probes;i++){
        const needTarget = Math.random() < (tLeft/nLeft);
        if(needTarget){ probes.push(pick(set)); isT.push(1); tLeft--; }
        else{ let d; do{ d=pick(cfg.allowZero?[0,1,2,3,4,5,6,7,8,9]:[1,2,3,4,5,6,7,8,9]); }while(set.includes(d));
          probes.push(d); isT.push(0);
        } nLeft--;
      }
      return {kind:'sternberg', cue:`STERNBERG ‚Äì Merke Set`, set, probes, isTarget:isT};
    }
    if(kind==='nback'){
      const n=cfg.nback.n; const len=cfg.nback.streamLen;
      const stream=[]; const targets=new Array(len).fill(0);
      for(let i=0;i<len;i++){
        if(i>=n && Math.random()<cfg.nback.targetRate){ stream[i]=stream[i-n]; targets[i]=1; }
        else{ stream[i]=pick(cfg.allowZero?[0,1,2,3,4,5,6,7,8,9]:[1,2,3,4,5,6,7,8,9]); }
      }
      return {kind:'nback', cue:`${n}-BACK ‚Äì Treffer wenn gleich vor ${n}`, n, stream, targets};
    }
    return {...common, cue:'RECALL', target:baseStr};
  }

  function run(){
    const ui=card(); root.appendChild(ui);
    ui.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <span class="pill">Zeit: <span id="t" class="timer">‚Äî</span></span>
        <span class="pill">Score: <b id="sc">0</b></span>
        <span class="pill">Item: <b id="ic">0</b></span>
      </div>
      <div class="center" style="margin-top:6px">
        <div id="cue" class="cue">‚Äî</div>
        <div id="stim" class="stim">‚Ä¢</div>
      </div>
      <div id="answerBlock" class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <input id="a" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Antwort‚Ä¶" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="width:280px">
        <button id="ok" class="btn huge">OK</button>
        <button id="skip" class="btn ghost huge">Skip</button>
        <button id="clear" class="btn ghost huge">Clear</button>
      </div>
      <div id="ynBlock" class="row center" style="justify-content:center;gap:12px;margin-top:6px;display:none">
        <button id="no" class="btn huge">Nein</button>
        <button id="yes" class="btn huge">Ja</button>
      </div>
      <div class="row center" style="justify-content:center;gap:10px;margin-top:6px">
        <button id="abort" class="btn danger">Abbrechen</button>
      </div>
      <div class="muted center" style="margin-top:6px">
        Shortcuts: <span class="kbd">Enter</span>=OK/Ja ¬∑ <span class="kbd">Space</span>=Skip/Nein
      </div>
    `;

    const el={t:$('#t',ui),sc:$('#sc',ui),ic:$('#ic',ui),cue:$('#cue',ui),stim:$('#stim',ui),
              a:$('#a',ui),ok:$('#ok',ui),skip:$('#skip',ui),clear:$('#clear',ui),
              yn:$('#ynBlock',ui), yes:$('#yes',ui), no:$('#no',ui), ans:$('#answerBlock',ui),
              abort:$('#abort',ui)};

    // session state
    const per=[]; let score=0, correct=0, wrong=0, skipped=0;
    let running=true, finished=false; const totalMs=cfg.seconds*1000;
    let state='IDLE', cur=null, qStart=0, currentFail=null;
    const timers=[];
    const setT=(fn,ms)=>{ const id=setTimeout(fn,ms); timers.push(id); return id; };
    const clearAll=()=>{ while(timers.length) clearTimeout(timers.pop()); };
    const keyHandlers=[];
    const addKey=(fn)=>{ window.addEventListener('keydown',fn); keyHandlers.push(fn); };
    const clearKeys=()=>{ keyHandlers.forEach(fn=>window.removeEventListener('keydown',fn)); keyHandlers.length=0; };

    function setAnswerMode(onText){ el.ans.style.display=onText?'flex':'none'; el.yn.style.display=onText?'none':'flex'; }
    function showBullets(){ el.stim.textContent=bullets((cur && cur.len)||Math.max(cfg.lenMin,4)); }
    function updateScore(){ el.sc.textContent=String(score); el.ic.textContent=String(per.length); }
    function pushRec(rec){ per.push(rec); if(rec.skipped){ skipped++; } else if(rec.correct){ correct++; score += 1; } else { wrong++; } updateScore(); }

    function nextItem(){
      if(!running) return;
      cur = makeItem();
      el.cue.textContent=cur.cue;

      // Streams
      if(cur.kind==='sternberg') return runSternberg(cur);
      if(cur.kind==='nback')    return runNback(cur);

      // Einzel-Item
      setAnswerMode(true);
      el.a.value=''; el.a.maxLength=cur.len; el.a.focus();
      el.stim.textContent = cur.baseStr.split('').join(' ');
      setT(()=>{ el.stim.textContent = (cur.kind==='interference') ? '‚Ä¶' : bullets(cur.len); }, perDigitMs());
      if(cur.kind==='interference'){
        const dly = perDigitMs() + 150;
        setT(()=>{ el.cue.textContent = `DISTRACTOR ‚Äì nur ansehen`; el.stim.textContent=cur.distract; }, dly);
        setT(()=>{ el.cue.textContent = cur.cue; showBullets(); startAnswer(); }, dly + rndInt(800,1500));
      }else{
        setT(()=>{ startAnswer(); }, perDigitMs()+50);
      }
    }

    function startAnswer(){
      if(!running) return;
      state='ANSWER'; qStart=now();
      const deadline=ansTimeoutMs();
      currentFail=()=>{ pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user:'', correct:0, ms:'', len:cur.len, deadline:1, cue:cur.cue}); startITI(); };
      setT(currentFail, deadline);
    }

    function submitText(kind){
      if(state!=='ANSWER' || !running) return;
      if(kind==='skip'){ pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user:'', correct:null, ms:'', len:cur.len, skipped:1, cue:cur.cue}); startITI(); return; }
      if(kind==='clear'){ el.a.value=''; el.a.focus(); return; }
      const user = el.a.value; if(user.length!==cur.len){ el.a.focus(); return; }
      const ms=Math.round(now()-qStart);
      const ok = (user===cur.target);
      flash(ok);
      pushRec({kind:cur.kind, code:cur.baseStr, target:cur.target, user, correct:ok?1:0, ms, len:cur.len, cue:cur.cue});
      startITI();
    }

    function flash(ok){
      el.stim.classList.remove('flash-ok','flash-bad');
      el.stim.classList.add(ok?'flash-ok':'flash-bad');
      setT(()=>el.stim.classList.remove('flash-ok','flash-bad'),150);
    }

    function startITI(){ currentFail=null; state='ITI'; setT(()=>{ nextItem(); }, itiMs()); }

    // STERNBERG
    function runSternberg(it){
      setAnswerMode(false);
      const perDigit = perDigitMs();
      el.cue.textContent='STERNBERG ‚Äì Set merken';
      let idx=0;
      function showNext(){
        if(!running) return;
        if(idx<it.set.length){
          el.stim.textContent=String(it.set[idx]); idx++; setT(showNext, perDigit);
        }else{
          el.stim.textContent='‚Ä¢';
          setT(()=>runProbes(), 250);
        }
      }
      showNext();
      function runProbes(){
        let k=0;
        function step(){
          if(!running) return;
          if(k>=it.probes.length) { startITI(); return; }
          el.cue.textContent='Probe: war sie im Set?';
          el.stim.textContent=String(it.probes[k]);
          const start=now();
          setAnswerMode(false);
          const deadline=ansTimeoutMs(); let answered=false;
          function done(resp){
            if(answered || !running) return; answered=true;
            const rt=Math.round(now()-start);
            const truth=it.isTarget[k]===1; const ok = (resp==='Y')===truth;
            flash(ok);
            pushRec({kind:'sternberg', probe:k+1, set:digitsToStr(it.set), digit:it.probes[k], isTarget:truth?1:0,
                     resp:(resp==='Y'?'Y':'N'), correct:ok?1:0, ms:rt, cue:'STERNBERG'});
            k++; setT(step, itiMs());
          }
          currentFail=()=>done('Z');
          setT(currentFail, deadline);
          const key=(e)=>{ if(e.key==='Enter') done('Y'); else if(e.key===' ') { e.preventDefault(); done('N'); } };
          addKey(key);
          el.yes.onclick=()=>done('Y'); el.no.onclick=()=>done('N');
        }
        step();
      }
    }

    // N-BACK
    function runNback(it){
      setAnswerMode(false);
      el.cue.textContent=`${it.n}-BACK ‚Äì Treffer wenn gleich vor ${it.n}`;
      let k=0; const dly=rndInt(500,900);
      function step(){
        if(!running) return;
        if(k>=it.stream.length){ startITI(); return; }
        el.stim.textContent=String(it.stream[k]);
        const start=now(); const isTarget = it.targets[k]===1;
        const deadline = Math.max(400, dly-50); let answered=false;
        function done(hit){
          if(answered || !running) return; answered=true;
          const rt=Math.round(now()-start);
          const ok = (hit===true)===isTarget;
          flash(ok);
          pushRec({kind:'nback', n:it.n, pos:k+1, digit:it.stream[k], target:isTarget?1:0, resp:hit?1:0, correct:ok?1:0, ms:rt, cue:`${it.n}-BACK`});
          k++; setT(step, 100);
        }
        currentFail=()=>done(false);
        setT(currentFail, deadline);
        const key=(e)=>{ if(e.key==='Enter') done(true); else if(e.key===' ') { e.preventDefault(); done(false); } };
        addKey(key);
        el.yes.onclick=()=>done(true); el.no.onclick=()=>done(false);
      }
      step();
    }

    // Controls
    el.ok.onclick = ()=>submitText('ok');
    el.skip.onclick = ()=>submitText('skip');
    el.clear.onclick = ()=>submitText('clear');
    el.a.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); submitText('ok'); } else if(e.key===' '){ e.preventDefault(); submitText('skip'); } });
    el.a.addEventListener('input',()=>{
      if(state!=='ANSWER' || !cur || el.ans.style.display==='none') return;
      const v=el.a.value.replace(/\D/g,'').slice(0,cur.len);
      if(el.a.value!==v) el.a.value=v;
      if(v.length===cur.len && v===cur.target) submitText('ok');
    });
    el.abort.onclick=()=>{ if(confirm('Ohne Speichern beenden?')){ running=false; forceEnd(); } };

    function forceEnd(){
      if(!running || finished) return;
      if(typeof currentFail==='function'){ try{ currentFail(); }catch{} }
      finish();
    }

    function finish(){
      if(finished) return; finished=true;
      running=false; currentFail=null;
      clearAll(); clearKeys();
      const stats={correct, wrong, skipped, score};
      pushSession({module:'pc_pro', stats, settings:{...cfg}, perQuestion:per});
      const rows=[["#","kind","cue","code/set","target/digit","user/resp","ok","ms"]];
      per.forEach((x,i)=>{
        rows.push([i+1,x.kind,x.cue||'', x.code||x.set||'', x.target||x.digit||'', (x.user!=null?x.user:(x.resp!=null?x.resp:'')), (x.correct==null?'':(x.correct?1:0)), x.ms||'']);
      });
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const txt=per.map((x,i)=>`${i+1}. ${x.kind} | ${x.cue||''} | base=${x.code||x.set||''} | targ=${x.target||x.digit||''} | user=${x.user??(x.resp??'')} | ok=${x.correct==null?'':(x.correct?1:0)} | ms=${x.ms||''}`).join('\n');

      ui.innerHTML=`
        <h3>Ergebnis (Pro)</h3>
        <div class="row">
          <span class="pill">Richtig: <b class="ok">${stats.correct}</b></span>
          <span class="pill">Falsch: <b class="bad">${stats.wrong}</b></span>
          <span class="pill">Skips: <b class="warn">${stats.skipped}</b></span>
          <span class="pill">Score: <b>${stats.score}</b></span>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="dlCsv">Download CSV</button>
          <button class="btn ghost" id="dlTxt">Download TXT</button>
        </div>
        ${table(per.slice(-200).map((x,i)=>[
          i+1, x.kind, x.cue||'', (x.code||x.set||'‚Äî'), (x.target||x.digit||'‚Äî'),
          (x.user!=null?x.user:(x.resp!=null?x.resp:'‚Äî')),
          x.correct==null?'‚è≠':(x.correct? '‚úÖ':'‚ùå'),
          x.ms? (x.ms/1000).toFixed(2)+'s':''
        ]),['#','Typ','Cue','Basis','Ziel/Digit','Antwort','OK','Zeit'])}
      `;
      $('#dlCsv',ui).onclick=()=>dl('pincode_pro_'+new Date().toISOString().replace(/[:.]/g,'-')+'.csv',csv,'text/csv');
      $('#dlTxt',ui).onclick=()=>dl('pincode_pro_'+new Date().toISOString().replace(/[:.]/g,'-')+'.txt',txt,'text/plain');
      render();
    }

    // Session-Timer (hartes Ende + Penalty)
    const t0=performance.now();
    (function loop(){
      if(finished) return;
      const used=performance.now()-t0, left=Math.max(0, totalMs-used);
      el.t.textContent=(left/1000).toFixed(1)+'s';
      if(left<=0){ running=false; return forceEnd(); }
      requestAnimationFrame(loop);
    })();

    nextItem();
  }
}

/************* Statistik *************/
function viewStats(root){
  root.appendChild(card(`<h2>üìä Statistik</h2><div class="muted">Classic, Step, Trainer & Pro. Skips z√§hlen nicht als falsch.</div>`));
  const arr=DB.sessions.filter(s=>['pc_classic','pc_step','pc_trainer','pc_pro'].includes(s.module));
  const sum=f=>arr.reduce((a,x)=>a+(f(x)||0),0);
  const el=card(`<div class="row">
      <span class="pill">Sessions: <b>${arr.length}</b></span>
      <span class="pill">√ò Richtig/Run: <b>${(sum(s=>s.stats?.correct)/Math.max(1,arr.length)).toFixed(1)}</b></span>
      <span class="pill">Highscore: <b>${DB.highscores.pc?.score ?? '‚Äî'}</b></span>
    </div>`);
  const rows=arr.slice(-50).map((s,i)=>[
    i+1, new Date(s.date).toLocaleString(),
    s.module, s.stats.correct, s.stats.wrong, s.stats.skipped,
    `<span class="linklike" data-idx="${DB.sessions.indexOf(s)}">Details</span>`
  ]);
  el.insertAdjacentHTML('beforeend', table(rows,['#','Datum','Modul','Richtig','Falsch','Skips','Session'], [6]));
  root.appendChild(el);
  el.addEventListener('click',ev=>{
    const t=ev.target.closest('.linklike'); if(!t) return;
    const idx=+t.dataset.idx; const s=DB.sessions[idx];
    const txt=(s?.perQuestion||[]).map((x,j)=>`${j+1}. ${x.kind||'classic'} | ${x.cue||''} | base=${x.code||x.set||''} | targ=${x.target||x.digit||''} | user=${x.user??(x.resp??'')} | ok=${x.correct==null?'':(x.correct?1:0)} | ms=${x.ms||''}`).join('\n');
    const url=URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
    const a=document.createElement('a'); a.href=url; a.download='session_'+new Date(s.date).toISOString().replace(/[:.]/g,'-')+'.txt'; a.click(); URL.revokeObjectURL(url);
  });
}

/************* Einstellungen *************/
function viewSettings(root){
  root.appendChild(card(`<h2>‚öôÔ∏è Einstellungen</h2><div class="muted">Datenpflege.</div>`));
  const box=card(); box.appendChild(formRow([
    btn("Nur Highscore l√∂schen",()=>{ delete DB.highscores.pc; save(DBKEY,DB); alert("Highscore gel√∂scht."); },'btn ghost'),
    btn("Alle Pincode-Sessions l√∂schen",()=>{ DB.sessions=DB.sessions.filter(s=>!['pc_classic','pc_step','pc_trainer','pc_pro'].includes(s.module)); save(DBKEY,DB); alert("Sessions gel√∂scht."); render(); },'btn danger'),
  ]));
  root.appendChild(box);
}

/************* kleine UI-Bausteine *************/
function card(html=''){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; return d; }
function formRow(items){ const r=document.createElement('div'); r.className='row grid cols-2'; items.forEach(x=>r.appendChild(x)); return r; }
function btn(label,fn,cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=label; b.onmousedown=e=>e.preventDefault(); b.onclick=fn; return b; }
function numberField(label,min,max,step,val,onInput){
  const w=document.createElement('div'); const id='n'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><input id="${id}" inputmode="numeric" type="number" min="${min}" max="${max}" step="${step}" value="${val}">`;
  const el=$('input',w); el.addEventListener('input',e=>onInput(parseInt(e.target.value))); return w;
}
function selectField(label, opts, onCh, val){
  const w=document.createElement('div'); const id='s'+Math.random().toString(36).slice(2);
  w.innerHTML=`<label for="${id}">${label}</label><select id="${id}">${opts.map(([v,l])=>`<option value="${v}">${l}</option>`).join('')}</select>`;
  const el=$('select',w); el.value=val; el.addEventListener('change',e=>onCh(e.target.value)); return w;
}

/* GLOBAL table()-Helper (f√ºr alle Views/Ergebnisse/Statistik) */
function table(rows, headers, rawCols = []) {
  const esc = s => (s ?? '').toString().replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
  const thead = `<thead><tr>${headers.map(h => `<th>${esc(h)}</th>`).join('')}</tr></thead>`;
  const tbody = `<tbody>${
    rows.map(r => `<tr>${
      r.map((c, idx) => `<td>${rawCols.includes(idx) ? (c ?? '') : esc(c)}</td>`).join('')
    }</tr>`).join('')
  }</tbody>`;
  return `<table>${thead}${tbody}</table>`;
}

/* Boot */
render();
</script>
</main>
</body>
</html>
